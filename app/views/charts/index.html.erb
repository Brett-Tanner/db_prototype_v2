<main id="charts_index">
    <% internal_invoices = @invoices.select { |i| i.child.member? }.map(&:id) %>
    <% external_invoices = @invoices.reject { |i| i.child.member? }.map(&:id) %>
    <% new_slots = TimeSlot.where('created_at > ?', "1 July 2023") %>

    <%# Bookings %>

    <%= line_chart @slot_registrations.group_by_day(:created_at).count, 
                   title: 'Daily Registrations',
                   time_zone: false %>

    <%= line_chart @invoices.group_by_day(:created_at).count,
                   title: 'Daily Bookings',
                   time_zone: false %>

    <%= line_chart @invoices.group_by_day(:created_at).sum(:total_cost),
                   title: 'Daily Revenue',
                   suffix: "円",
                   time_zone: false %>

    <%= line_chart @invoices.group_by_week(:created_at).count,
                   title: 'Weekly Bookings',
                   time_zone: false %>

    <%= line_chart @invoices.group_by_week(:created_at).sum(:total_cost),
                   title: 'Weekly Revenue',
                   suffix: "円",
                   time_zone: false %>

    <%= column_chart @invoices.group_by_day_of_week(:created_at, format: '%A').count,
    title: 'Bookings by Day of the Week',
    time_zone: false %>

    <%= column_chart @invoices.group(:event_id).average(:total_cost).to_h { |k, v| [@school_hash[k], v] }.sort_by { |_k, v| v }.reverse, title: 'Average Booking Cost by School', round: 0, max: 40_000, suffix: "円", height: '75dvh' %>

    <div class="d-flex justify-content-center align-items-center gap-5 p-3 w-100 text-center">
        <div class="d-flex flex-column">
            <h2 class="fw-semibold text-primary">
                <%= number_to_currency(@invoices.average(:total_cost),
                                        unit: '円',
                                        precision: 0,
                                        locale: :ja) %>
            </h2>
            <p>Average Booking Cost</p>
        </div>
        <div class="d-flex flex-column">
            <h2 class="fw-semibold text-primary">
                <%= (@slot_registrations.count.to_f / @invoices.count).round(2) %>
            </h2>
            <p>Average Activities per Booking</p>
        </div>
    </div>

    <%# Activities %>

    <%= column_chart @invoices.joins(:time_slots).group(:event_id).count
                              .map { |k, v| [@school_hash[k], (v.to_f / Invoice.where(event_id: k).count )] }
                              .to_h
                              .sort_by { |_k, v| v }.reverse, 
                     title: 'Number of Activities per Booking by School',
                     round: 2, min: 3, max: 6.5, height: '50dvh' %>

    <%= column_chart @time_slots.where.not(id: new_slots.ids)
                                .left_joins(:registrations)
                                .group(:name).count
                                .sort_by { |_k, v| v }.reverse,
                                title: 'OG Activity Popularity',
                                height: '85dvh',
                                max: 1_100 %>

    <%= column_chart @time_slots.where(id: new_slots.ids)
                                .left_joins(:registrations)
                                .group(:name).count
                                .sort_by { |_k, v| v }.reverse,
                                title: 'New Activity Popularity',
                                height: '85dvh' %>

    <%= pie_chart @children.group(:grade).count,
                  title: 'Attendees by Grade',
                  donut: true,
                  height: '50dvh' %>

    <%# Coupons %>

    <% coupon_revenue_data = 
    School.where(id: [3, 9, 10, 11, 17, 20, 21, 25, 30, 34]).map do |school| 
            [school.name, (school.coupons.where(code: 'Thank youクーポン', couponable_id: internal_invoices).count * 3_000) + 
            (school.coupons.where(code: 'Thank youクーポン', couponable_id: external_invoices).count * 5_000)]
            end.sort_by {|s| s[1]}.reverse %>

    <%= line_chart @coupons.where.not(code: "")
                           .group(:code)
                           .group_by_day(:created_at).count,
                           title: "Daily Coupon Use",
                           time_zone: false %>

    <div class="d-flex justify-content-center align-items-center gap-5 p-3 w-100 text-center">
        <div class="d-flex flex-column">
            <h2 class="fw-semibold text-primary">
                <%= number_to_currency(coupon_revenue_data.reduce(0) { |sum, point| sum + point[1] }, unit: '円', precision: 0, locale: :ja) %>
            </h2>
            <p>Thank youクーポン Revenue</p>
        </div>
        <div class="d-flex flex-column">
            <h2 class="fw-semibold text-primary">
                <%= @coupons.select { |coupon| coupon.code ==  'Thank youクーポン' }.size %>
            </h2>
            <p>Thank youクーポン Count</p>
        </div>
    </div>

    <%= bar_chart coupon_revenue_data, title: "Coupon Revenue by School", suffix: "円" %>

    <%# Options %>

    <%= column_chart Option.joins(:registrations)
                           .group("options.name").count("options.name")
                           .except("なし")
                           .sort_by { |_k, v| v }.reverse,
                           title: "Option Popularity" %>

    <%= column_chart Option.joins(:registrations)
                           .group("options.name")
                           .sum("options.cost")
                           .except("なし")
                           .sort_by { |_k, v| v }.reverse,
                           title: "Option Revenue",
                           suffix: "円" %>

    <div class="w-100 d-flex justify-items-around">
        <%= pie_chart Option.where(category: [:arrival, :k_arrival])
                            .joins(:registrations)
                            .group("options.name").count("options.name")
                            .except("なし"),
                            title: "Arrival Option Popularity",
                            legend: "left",
                            height: "30vw" %>
        <%= pie_chart Option.where(category: [:departure, :k_departure])
                            .joins(:registrations)
                            .group("options.name").count("options.name")
                            .except("なし"),
                            title: "Departure Option Popularity",
                            legend: "left",
                            height: "30vw" %>
    </div>

    <%# Edits %>

    <% customers = User.customer.ids %>
    <%= line_chart @versions.where(whodunnit: customers)
                            .group_by_day(:created_at).count,
                            title: "Customer Edits by Day" %>

    <% staff = User.where(role: %i[area_manager school_manager admin]).ids %>
    <%= line_chart @versions.where(whodunnit: staff)
                            .group_by_day(:created_at).count,
                            title: "Staff Edits by Day" %>
</main>