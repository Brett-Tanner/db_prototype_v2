<main id="slot_attendance">
    <% ext_cats = %w[extension k_extension].freeze %>
    <% extensions = @options.select { |o| ext_cats.include?(o.category) } %>
    <% ext_ids = extensions.map(&:id) %>

    <% time_cats = %w[arrival departure k_arrival k_departure].freeze %>
    <% time_opts = @options.select { |o| time_cats.include?(o.category) } %>
    <% time_ids = time_opts.map(&:id) %>

    <% options = @options.reject { |o| (time_ids + ext_ids).include?(o.id) } %>
    
    <div class="slot_attendance mb-5" 
         data-controller="refresh print"
         data-print-target="print">

        <div class="links d-flex gap-3">
            <%= link_to t('.back_to_event'),
                        children_path(id: @slot.event_id, source: 'event'),
                        class: 'btn btn-primary ms-3' %>
            <%= button_tag t('.print'),
                           class: 'btn btn-primary print',
                           data: { action: "click->print#print" } %>
            <% if @slot.special? && @afternoon %>
              <%= link_to @afternoon.name,
                          children_path(
                            id: @afternoon.id,
                            source: 'time_slot'
                          ),
                          class: 'btn btn-primary' %>
            <% elsif @slot.special? && @slot.morning_slot %>
              <%= link_to @slot.morning_slot.name,
                        children_path(
                          id: @slot.morning_slot.id,
                          source: 'time_slot'
                        ),
                        class: 'btn btn-primary' %>
            <% end %>
        </div>

        <h1 class="text-center"><%= @slot.name_date %></h1>

        <h2 class="counter text-center">
            <span data-refresh-target="counter">10:00</span>
            後にページが更新される。
        </h2>
    
        <table class="table table-sm table-light table-striped table-hover table-bordered text-center text-nowrap align-middle">
            <thead class="sticky-top">
                <tr class="table-primary">
                    <th>
                        <%= t('.arrival') %>
                    </th>
                    <th>
                        <p><%=  t('.attend') %></p>
                        <p>
                            <%= "K: #{@children.count(&:kindy)}, E: #{@children.reject(&:kindy).size}" %>
                        </p>
                    </th>
                    <th><%= t('.name') %></th>
                    <th>幼児/小学生</th>
                    <th><%= t('.allergy') %></th>
                    <th><%= t('.photo') %></th>

                    <% @event_options.each do |o| %>
                        <th scope="col"><%= o.name %></th>
                    <% end %>

                    <% options.each do |o| %>
                        <th scope="col">
                            <%= "#{o.name}: #{o.registrations.size}" %>
                        </th>
                    <% end %>
    
                    <% if @slot.special? && extensions.size.positive? %>
                        <th>
                            中延長: 
                            <%= "#{extensions.reduce(0) { |sum, o| sum + o.registrations.size }}" %>
                        </th>
                    <% end %>
    
                    <% if @afternoon %>
                        <th scope="col" id="afternoon_header">
                            <p><%= t('.attend_afternoon') %></p>
                            <p>
                                <%= "K: #{@afternoon_children.count(&:kindy)}, E: #{@afternoon_children.reject(&:kindy).size}" %>
                            </p>
                        </th>
    
                        <% @afternoon_options.each do |opt| %>
                            <th scope="col"><%= "#{opt.name}: #{opt.registrations.size}" %></th>
                        <% end %>
      
                        <th scope="col" id="depart_header">
                            <%= t('.depart') %>
                        </th>
                    <% end %>
                </tr>
            </thead>
            <tbody>
                <tr class="search">
                    <td data-controller="filter"
                    data-filter-siblings-value="0"
                    data-filter-col-value=".arrival">
                        <div class="form-floating">
                            <%= text_field_tag 'arrival_filter',
                                    nil,
                                    { 
                                    placeholder: t('.filter'),
                                    class: 'form-control',
                                    data: {
                                        action: 'keydown.enter->filter#change',
                                        'filter-target' => 'input'
                                        }
                                    }%>
                            <%= label_tag 'arrival_filter',
                                          t('.filter'),
                                          class: 'form-label' %>
                        </div>
                    </td>
    
                    <td data-controller="filter"
                        data-filter-siblings-value="0"
                        data-filter-col-value=".morning">
                        <div class="form-floating">
                            <%= text_field_tag 'morning_filter',
                                    nil,
                                    {
                                        placeholder: t('.filter'),
                                        class: 'form-control',
                                        data: {
                                            action: 'keydown.enter->filter#change',
                                            'filter-target' => 'input'
                                          }
                                        }%>
                            <%= label_tag 'morning_filter',
                                          t('.filter'),
                                          class: 'form-label' %>
                        </div>
                    </td>

                    <td data-controller="filter"
                        data-filter-siblings-value="0"
                        data-filter-col-value=".name">
                        <div class="form-floating">
                            <%= text_field_tag 'name_filter',
                                    nil,
                                    {
                                        placeholder: t('.filter'),
                                        class: 'form-control',
                                        data: {
                                            action: 'keydown.enter->filter#change',
                                            'filter-target' => 'input' 
                                          }
                                        }%>
                            <%= label_tag 'name_filter',
                                           t('.filter'),
                                           class: 'form-label' %>
                        </div>
                    </td>

                    <td data-controller="filter"
                        data-filter-siblings-value="0"
                        data-filter-col-value=".category">
                        <div class="form-floating">
                            <%= text_field_tag 'category_filter',
                                    nil,
                                    {
                                        placeholder: t('.filter'),
                                        class: 'form-control',
                                        data: {
                                            action: 'keydown.enter->filter#change',
                                            'filter-target' => 'input'
                                          }
                                        }%>
                            <%= label_tag 'category_filter',
                                          t('.filter'),
                                          class: 'form-label' %>
                        </div>
                    </td>

                    <td data-controller="filter"
                        data-filter-siblings-value="0"
                        data-filter-col-value=".allergy">
                        <div class="form-floating">
                            <%= text_field_tag 'allergy_filter', nil, { placeholder: t('.filter'), class: 'form-control', data: { action: 'keydown.enter->filter#change', 'filter-target' => 'input' } }%>
                            <%= label_tag 'allergy_filter', t('.filter'), class: 'form-label' %>
                        </div>
                    </td>

                    <td data-controller="filter"
                        data-filter-siblings-value="0"
                        data-filter-col-value=".photos">
                        <div class="form-floating">
                            <%= text_field_tag 'photos_filter', nil, { placeholder: t('.filter'), class: 'form-control', data: { action: 'keydown.enter->filter#change', 'filter-target' => 'input' } }%>
                            <%= label_tag 'photos_filter', t('.filter'), class: 'form-label' %>
                        </div>
                    </td>

                    <% @event_options.each do |o| %>
                        <td data-controller="filter"
                            data-filter-siblings-value="0"
                            data-filter-col-value=".<%= o.name %>">
                            <div class="form-floating">
                                <%= text_field_tag "#{o.name}_filter", nil, { placeholder: t('.filter'), class: 'form-control', data: { action: 'keydown.enter->filter#change', 'filter-target' => 'input' } }%>
                                <%= label_tag "#{o.name}_filter", t('.filter'), class: 'form-label' %>
                            </div>
                        </td>
                    <% end %>

                    <% options.each do |opt| %>
                        <td data-controller="filter"
                            data-filter-siblings-value="0"
                            data-filter-col-value=".<%= opt.name %>">
                            <div class="form-floating">
                                <%= text_field_tag "#{opt.name}_filter", nil, { placeholder: t('.filter'), class: 'form-control', data: { action: 'keydown.enter->filter#change', 'filter-target' => 'input' } }%>
                                <%= label_tag "#{opt.name}_filter", t('.filter'), class: 'form-label' %>
                            </div>
                        </td>
                    <% end %>
    
                    <% if @slot.special? && extensions.size.positive? %>
                        <td data-controller="filter"
                            data-filter-siblings-value="0"
                            data-filter-col-value=".extend">
                            <div class="form-floating">
                                <%= text_field_tag 'extend_filter', nil, { placeholder: t('.filter'), class: 'form-control', data: { action: 'keydown.enter->filter#change', 'filter-target' => 'input' } }%>
                                <%= label_tag 'extend_filter', t('.filter'), class: 'form-label' %>
                            </div>
                        </td>
                    <% end %>
    
                    <% if @afternoon %>
                      <td data-controller="filter"
                        data-filter-siblings-value="0"
                        data-filter-col-value=".afternoon">
                        <div class="form-floating">
                            <%= text_field_tag 'afternoon_filter', nil, { placeholder: t('.filter'), class: 'form-control', data: { action: 'keydown.enter->filter#change', 'filter-target' => 'input' } }%>
                            <%= label_tag 'afternoon_filter', t('.filter'), class: 'form-label' %>
                        </div>
                        </td>
                        <% @afternoon_options.each do |opt| %>
                            <td data-controller="filter"
                                data-filter-siblings-value="0"
                                data-filter-col-value=".<%= opt.name %>">
                                <div class="form-floating">
                                    <%= text_field_tag "#{opt.name}_filter", nil, { placeholder: t('.filter'), class: 'form-control', data: { action: 'keydown.enter->filter#change', 'filter-target' => 'input' } }%>
                                    <%= label_tag "#{opt.name}_filter", t('.filter'), class: 'form-label' %>
                                </div>
                            </td>
                        <% end %>
    
                        <td data-controller="filter"
                            data-filter-siblings-value="0"
                            data-filter-col-value=".depart">
                            <div class="form-floating">
                                <%= text_field_tag 'depart_filter', nil, { placeholder: t('.filter'), class: 'form-control', data: { action: 'keydown.enter->filter#change', 'filter-target' => 'input' } }%>
                                <%= label_tag 'depart_filter', t('.filter'), class: 'form-label' %>
                            </div>
                        </td>
                    <% end %>
                </tr>
    
                <%= render partial: 'children/time_slots/child_row',
                           collection: (@children + (@afternoon_children || [])),
                           as: :child,
                           locals: {
                                afternoon: @afternoon,
                                afternoon_options: @afternoon_options,
                                event_options: @event_options,
                                ext_ids: ext_ids,
                                options: options,
                                slot: @slot
                           } %>
            </tbody>
        </table>
    </div>
</main>