<main id="slot_attendance">
    <% time_cats = %w[arrival departure k_arrival k_departure] %>
    <% ext_cats = %w[extension k_extension] %>
    
    <% morn_time_ids = @options.select { |opt| time_cats.include?(opt.category) }.map(&:id) %>
    
    <% extensions = @options.select { |opt| ext_cats.include?(opt.category) } %>
    <% extension_ids = extensions.map(&:id) %>
    
    <% morn_options = @options.reject { |opt| morn_time_ids.include?(opt.id) || extension_ids.include?(opt.id) } %>
    <% aft_options = @afternoon_options unless @afternoon.nil? %>
    
    <% child_ids = @children.map(&:id) %>
    <% morn_child_ids = @children.map(&:id) %>
    <% aft_child_ids = @afternoon_children.map(&:id) if @afternoon %>
    
    <div class="slot_attendance mb-5" data-controller="refresh print" data-print-target="print">
        <div class="links d-flex gap-3">
            <%= link_to t('.back_to_event'), children_path(id: @slot.event_id, source: 'event'), class: 'btn btn-primary ms-3' %>
            <%= button_tag t('.print'), class: 'btn btn-primary print', data: { action: "click->print#print" } %>
        </div>
        <h1 class="text-center"><%= "#{@slot.name} (#{@slot.date})" %></h1>
        <h2 class="counter text-center"><span data-refresh-target="counter">10:00</span>後にページが更新される。</h2>
    
        <table class="table table-sm table-light table-striped table-hover table-bordered text-center text-nowrap align-middle">
            <thead class="sticky-top">
                <tr class="table-primary">
                    <th>
                        <%= @slot.name == "夏祭り" ? "中延長: #{extensions.reduce(0) { |sum, opt| sum + opt.registrations.select { |reg| child_ids.include?(reg.child_id)}.size }}" : t('.arrival') %>
                    </th>
                    <th>
                        <p><%=  t('.attend_morning') %></p>
                        <p>
                            <%= "K: #{@children.select(&:kindy).size}, E: #{@children.reject(&:kindy).size}" %>
                        </p>
                    </th>
                    <th><%= t('.name') %></th>
                    <th>幼児/小学生</th>
                    <th><%= t('.allergy') %></th>
                    <th><%= t('.photo') %></th>
                    <% @event_options.each do |opt| %>
                        <th scope="col"><%= opt.name %></th>
                    <% end %>
                    <% morn_options.each do |opt| %>
                        <th scope="col"><%= "#{opt.name}: #{opt.registrations.select{ |reg| child_ids.include?(reg.child_id) }.size}" %></th>
                    <% end %>
    
                    <% if @slot.special? && extensions.size.positive? %>
                        <th><%= "#{extensions.first.name}: #{extensions.reduce(0) { |sum, opt| sum + opt.registrations.select { |reg| child_ids.include?(reg.child_id)}.size }}" %></th>
                    <% end %>
    
                    <% if @afternoon %>
                        <th scope="col" id="afternoon_header">
                            <p><%= t('.attend_afternoon') %></p>
                            <p>
                                <%= "K: #{@afternoon_children.select(&:kindy).size}, E: #{@afternoon_children.reject(&:kindy).size}" %>
                            </p>
                        </th>
    
                        <% @afternoon_options.each do |opt| %>
                            <th scope="col"><%= "#{opt.name}: #{opt.registrations.select{ |reg| child_ids.include?(reg.child_id) }.size}" %></th>
                        <% end %>
      
                        <th scope="col" id="depart_header"><%= t('.depart') %></th>
                    <% end %>
                </tr>
            </thead>
            <tbody>
                <tr class="search">
                    <td data-controller="filter"
                    data-filter-siblings-value="0"
                    data-filter-col-value=".arrival">
                        <div class="form-floating">
                            <%= text_field_tag 'arrival_filter', nil, { placeholder: t('.filter'), class: 'form-control', data: { action: 'keydown.enter->filter#change', 'filter-target' => 'input' } }%>
                            <%= label_tag 'arrival_filter', t('.filter'), class: 'form-label' %>
                        </div>
                    </td>
    
                    <td data-controller="filter"
                        data-filter-siblings-value="0"
                        data-filter-col-value=".morning">
                        <div class="form-floating">
                            <%= text_field_tag 'morning_filter', nil, { placeholder: t('.filter'), class: 'form-control', data: { action: 'keydown.enter->filter#change', 'filter-target' => 'input' } }%>
                            <%= label_tag 'morning_filter', t('.filter'), class: 'form-label' %>
                        </div>
                    </td>
                    <td data-controller="filter"
                        data-filter-siblings-value="0"
                        data-filter-col-value=".name">
                        <div class="form-floating">
                            <%= text_field_tag 'name_filter', nil, { placeholder: t('.filter'), class: 'form-control', data: { action: 'keydown.enter->filter#change', 'filter-target' => 'input' } }%>
                            <%= label_tag 'name_filter', t('.filter'), class: 'form-label' %>
                        </div>
                    </td>
                    <td data-controller="filter"
                        data-filter-siblings-value="0"
                        data-filter-col-value=".category">
                        <div class="form-floating">
                            <%= text_field_tag 'category_filter', nil, { placeholder: t('.filter'), class: 'form-control', data: { action: 'keydown.enter->filter#change', 'filter-target' => 'input' } }%>
                            <%= label_tag 'category_filter', t('.filter'), class: 'form-label' %>
                        </div>
                    </td>
                    <td data-controller="filter"
                        data-filter-siblings-value="0"
                        data-filter-col-value=".allergy">
                        <div class="form-floating">
                            <%= text_field_tag 'allergy_filter', nil, { placeholder: t('.filter'), class: 'form-control', data: { action: 'keydown.enter->filter#change', 'filter-target' => 'input' } }%>
                            <%= label_tag 'allergy_filter', t('.filter'), class: 'form-label' %>
                        </div>
                    </td>
                    <td data-controller="filter"
                        data-filter-siblings-value="0"
                        data-filter-col-value=".photos">
                        <div class="form-floating">
                            <%= text_field_tag 'photos_filter', nil, { placeholder: t('.filter'), class: 'form-control', data: { action: 'keydown.enter->filter#change', 'filter-target' => 'input' } }%>
                            <%= label_tag 'photos_filter', t('.filter'), class: 'form-label' %>
                        </div>
                    </td>
                    <% @event_options.each do |opt| %>
                        <td data-controller="filter"
                            data-filter-siblings-value="0"
                            data-filter-col-value=".<%= opt.name %>">
                            <div class="form-floating">
                                <%= text_field_tag "#{opt.name}_filter", nil, { placeholder: t('.filter'), class: 'form-control', data: { action: 'keydown.enter->filter#change', 'filter-target' => 'input' } }%>
                                <%= label_tag "#{opt.name}_filter", t('.filter'), class: 'form-label' %>
                            </div>
                        </td>
                    <% end %>

                    <% morn_options.each do |opt| %>
                        <td data-controller="filter"
                            data-filter-siblings-value="0"
                            data-filter-col-value=".<%= opt.name %>">
                            <div class="form-floating">
                                <%= text_field_tag "#{opt.name}_filter", nil, { placeholder: t('.filter'), class: 'form-control', data: { action: 'keydown.enter->filter#change', 'filter-target' => 'input' } }%>
                                <%= label_tag "#{opt.name}_filter", t('.filter'), class: 'form-label' %>
                            </div>
                        </td>
                    <% end %>
    
                    <% if @slot.special? && extensions.size.positive? %>
                        <td data-controller="filter"
                            data-filter-siblings-value="0"
                            data-filter-col-value=".extend">
                            <div class="form-floating">
                                <%= text_field_tag 'extend_filter', nil, { placeholder: t('.filter'), class: 'form-control', data: { action: 'keydown.enter->filter#change', 'filter-target' => 'input' } }%>
                                <%= label_tag 'extend_filter', t('.filter'), class: 'form-label' %>
                            </div>
                        </td>
                    <% end %>
    
                    <% if @afternoon %>
                      <td data-controller="filter"
                        data-filter-siblings-value="0"
                        data-filter-col-value=".afternoon">
                        <div class="form-floating">
                            <%= text_field_tag 'afternoon_filter', nil, { placeholder: t('.filter'), class: 'form-control', data: { action: 'keydown.enter->filter#change', 'filter-target' => 'input' } }%>
                            <%= label_tag 'afternoon_filter', t('.filter'), class: 'form-label' %>
                        </div>
                        </td>
                        <% @afternoon_options.each do |opt| %>
                            <td data-controller="filter"
                                data-filter-siblings-value="0"
                                data-filter-col-value=".<%= opt.name %>">
                                <div class="form-floating">
                                    <%= text_field_tag "#{opt.name}_filter", nil, { placeholder: t('.filter'), class: 'form-control', data: { action: 'keydown.enter->filter#change', 'filter-target' => 'input' } }%>
                                    <%= label_tag "#{opt.name}_filter", t('.filter'), class: 'form-label' %>
                                </div>
                            </td>
                        <% end %>
    
                        <td data-controller="filter"
                            data-filter-siblings-value="0"
                            data-filter-col-value=".depart">
                            <div class="form-floating">
                                <%= text_field_tag 'depart_filter', nil, { placeholder: t('.filter'), class: 'form-control', data: { action: 'keydown.enter->filter#change', 'filter-target' => 'input' } }%>
                                <%= label_tag 'depart_filter', t('.filter'), class: 'form-label' %>
                            </div>
                        </td>
                    <% end %>
                </tr>
    
                <%= render partial: 'children/time_slots/child_row',
                           collection: (@children + @afternoon_children),
                           as: :child,
                           locals: {
                                slot: @slot,
                                event_options: @event_options,
                                morn_options: morn_options,
                                afternoon_options: @afternoon_options,
                                extension_ids: extension_ids
                           } %>
            </tbody>
        </table>
    </div>
</main>