<% event_slots = event_child.time_slots.select { |slot| slot.event_id == event.id }.sort_by{ |slot| slot.start_time } %>
<% special = event_slots.select { |slot| slot.special? } %>
<% event_opts = event_child.options.select { |opt| event_slots.map { |slot| slot.id}.include?(opt.optionable_id) } %>
<% event_invoices = event_child.invoices.select { |invoice| invoice.event_id == event.id } %>
<% active_invoice = event_invoices.last %>

<tr>
    <th rowspan="2" class="order"><%= event_child_iteration.index + 1 %></th>
    <th rowspan="2" class="ja_name"><%= link_to event_child.name, child_path(event_child) %></th>
    <th rowspan="2" class="en_name"><%= link_to event_child.en_name, child_path(event_child) %></th>
    <th rowspan="2" class="ssid"><%= link_to event_child.ssid, child_path(event_child) %></th>
    <td rowspan="2">
        <%= number_to_currency(event_invoices.reduce(0) { |sum, invoice| sum + invoice.total_cost }, unit: 'ÂÜÜ', precision: 0, locale: :ja) %>
    </td>
    <td rowspan="2" data-controller="popup">
        <%= button_tag t('.view_summary'), class: 'button', data: { action: "click->popup#toggle" } %>
        <div class="hidden cost_summary" data-popup-target="popup">
            <% event_invoices.each do |invoice| %>
                <div class="card">
                    <%= button_tag '‚úñ', class: 'button', data: { action: "click->popup#toggle" } %>
                    <%= sanitize invoice.summary, tags: %w[h1 h2 h3 div p], attributes: %w[class id] %>
                </div>
            <% end %>
        </div>
    </td>
    <td rowspan="2" data-controller="popup" id=<%= "child#{event_child.id}changes" %> class="<%= 'highlight' if active_invoice.seen_at.nil? || active_invoice.versions.last.created_at > active_invoice.seen_at %>">
        <turbo-frame>
            <% if active_invoice.seen_at.nil? || active_invoice.versions.last.created_at > active_invoice.seen_at %>
                <%= button_tag t('.view_changes'), class: 'button', data: { action: "click->popup#toggle" } %>
                <div class="hidden changes" data-popup-target="popup">
                    <div class="card">
                        <% if active_invoice.seen_at.nil? %>
                            <% active_invoice.versions.each do |ver| %>
                                <% next if ver.index.zero? %>
                                <h3><%= ver.index %></h3>
                                <%= sanitize(Diffy::Diff.new(simple_format(ver.reify.summary), simple_format(active_invoice.summary)).to_s(:html), tags: %w[div li strong span ul], attributes: %w[class id]) unless ver.reify.nil? %>
                            <% end %>
                        <% else %>
                            <% active_invoice.versions.select { |ver| ver.created_at > active_invoice.seen_at }.each do |ver| %>
                                <% next if ver.index.zero? %>
                                <h3><%= ver.index %></h3>
                                <%= sanitize(Diffy::Diff.new(simple_format(ver.reify.summary), simple_format(active_invoice.summary)).to_s(:html), tags: %w[div li strong span ul], attributes: %w[class id]) unless ver.reify.nil? %>
                            <% end %>
                        <% end %>
                        <%= button_to t('.mark_seen'), seen_invoice_path(id: active_invoice.id, child: event_child.id), class: 'button', data: { action: "click->popup#toggle" } %>
                    </div>
                </div>
            <% end %>
        </turbo-frame>
    </td>
    
    <td rowspan="2"><% event_invoices.each do |invoice| %>
        <p><%= "##{invoice.id}: #{invoice.f_bill_date}" unless invoice.billing_date.nil? %></p>
    <% end %></td>
    <td rowspan="2" data-controller="popup">
        <%= button_tag t('.view_template'), class: 'button', data: { action: "click->popup#toggle" } %>
        <div class="hidden mail_template" data-popup-target="popup">
            <% event_invoices.each do |invoice| %>
                <div class="card">
                    <%= button_tag '‚úñ', class: 'button', data: { action: "click->popup#toggle" } %>
                    <%= invoice.email_template %>
                </div>
            <% end %>
        </div>
    </td>
    <td rowspan="2"><%= event_child.regular_schedule.days if event_child.regular_schedule %></td>
    <td rowspan="2"><%= 
        if event_child.allergies 
            '‚úì'
        else
            'êÑÇ'
        end
    %></td>
    <td rowspan="2"><%= event_child.allergy_details %></td>
    <td rowspan="2"><%= 
    if event_child.post_photos 
            '‚úì'
        else
            'êÑÇ'
        end 
    %></td>

    <% unless special.size.zero? %>
        <td colspan="3">
            <% first_slots = special.select { |slot| slot.morning? } %>
            <%= link_to "#{first_slots.first.name} (ÂçàÂâç)", children_path(id: first_slots.first.id, source: 'TimeSlot') %> / 
            <%= link_to "#{first_slots.last.name} (ÂçàÂæå)", children_path(id: first_slots.last.id, source: 'TimeSlot') %>
        </td>
    <% end %>

    <% event_slots.each do |slot| %>
        <% if slot.morning %>
            <td colspan="3"><%= link_to "#{slot.name} (#{slot.start_time.strftime('%mÊúà%dÊó•')})", children_path(id: slot.id, source: 'TimeSlot') %></td>
        <% elsif event_slots.include?(slot.morning_slot) %>
            <% next %>
        <% else %>
            <td colspan="3"><%= link_to "#{slot.name} (#{slot.start_time.strftime('%mÊúà%dÊó•')})", children_path(id: slot.id, source: 'TimeSlot') %></td>
        <% end %>
    <% end %>

    <%# TODO: Probably a more efficient way to do this %>
    <% (cols - event_slots.select{ |slot| slot.morning }.size - event_slots.reject { |slot| slot.morning || event_slots.any? { |e_slot| e_slot.id == slot.morning_slot_id} }.size).times do %>
        <td colspan="3"></td>
    <% end %>
</tr>
<tr>
    <% unless special.size.zero? %>
        <% first_slots = special.select { |slot| slot.morning? } %>
        <td><%=
            # FIXME: causing N + 1 queries 
            if event_slots.include?(first_slots.first) && event_slots.include?(first_slots.last)
                'ÂçàÂâç / ÂçàÂæå'
            elsif event_slots.include?(first_slots.first)
                'ÂçàÂâç'
            elsif event_slots.include?(first_slots.last)
                'ÂçàÂæå'
            else
                ''
            end
        %></td>
        <td><%=
            # FIXME: causing N + 1 queries 
            if event_opts.include?(first_slots.first.options.find_by(name: 'Êòº')) && event_opts.include?(first_slots.first.options.find_by(category: :extension))
                'Êòº / ‰∏≠Âª∂Èï∑'
            elsif event_opts.include?(first_slots.first.options.find_by(name: 'Êòº'))
                'Êòº'
            elsif event_opts.include?(first_slots.first.options.find_by(category: :extension))
                '‰∏≠Âª∂Èï∑'
            else
                ''
            end
        %></td>
        <td><%=
            # FIXME: causing N + 1 queries 
            if event_slots.include?(first_slots.last) && event_slots.include?(first_slots.first)
                "#{first_slots.first.arrival_time(event_child)} / #{first_slots.last.departure_time(event_child)}" unless first_slots.first.arrival_time(event_child) == '' && first_slots.last.departure_time(event_child) == ''
            elsif event_slots.include?(first_slots.first)
                "#{first_slots.first.arrival_time(event_child)}"
            else
                ''
            end
        %></td>
    <% end %>

    <% event_slots.each do |slot| %>
        <% if slot.morning %>
            <td><%=
                # FIXME: causing N + 1 queries 
                if event_slots.include?(slot.afternoon_slot) && event_slots.include?(slot)
                    'ÂçàÂâç / ÂçàÂæå'
                elsif event_slots.include?(slot)
                    'ÂçàÂâç'
                else
                    ''
                end
            %></td>

            <td><%=
                if event_opts.include?(slot.options.find_by(name: 'Êòº')) && event_opts.include?(slot.options.find_by(name: 'Êô©'))
                    'Êòº / Êô©'
                elsif event_opts.include?(slot.options.find_by(name: 'Êòº'))
                    'Êòº'
                elsif event_opts.include?(slot.options.find_by(name: 'Êô©'))
                    'Êô©'
                else
                    ''
                end
            %></td>

            <%# FIXME: N+1 queries %>
            <td><%=
                if event_slots.include?(slot.afternoon_slot) && event_slots.include?(slot)
                    "#{slot.arrival_time(event_child)} / #{slot.afternoon_slot.departure_time(event_child)}" unless slot.arrival_time(event_child) == '' && slot.afternoon_slot.departure_time(event_child) == ''
                elsif event_slots.include?(slot)
                    "#{slot.arrival_time(event_child)}"
                else
                    ''
                end
             %></td>
        <% elsif event_slots.include?(slot.morning_slot) %>
            <% next %>
        <% else %>
            <td>ÂçàÂæå</td>

            <td><%=
                if event_opts.include?(slot.options.find_by(name: 'Êòº')) && event_opts.include?(slot.options.find_by(name: 'Êô©'))
                    'Êòº / Êô©'
                elsif event_opts.include?(slot.options.find_by(name: 'Êòº'))
                    'Êòº'
                elsif event_opts.include?(slot.options.find_by(name: 'Êô©'))
                    'Êô©'
                else
                    ''
                end
            %></td>

            <%# FIXME: N+1 queries %>
            <td><%= "#{slot.departure_time(event_child)}" %></td>
        <% end %>
    <% end %>

    <%# TODO: Probabaly a more efficient way to do this %>
    <% (cols - event_slots.select{ |slot| slot.morning }.size - event_slots.reject { |slot| slot.morning || event_slots.any? { |e_slot| e_slot.id == slot.morning_slot_id} }.size).times do %>
            <td></td>
            <td></td>
            <td></td>
    <% end %>
</tr>