<% next_event = @user.children.first.school.next_event unless @user.children.empty? %>
<% schools = @user.children.map(&:school).map(&:name).uniq %>


<main id="user_show" class="gap-3">
    <div class="text-center">
        <% if @user.admin? %>
          <h1 class="fw-bold"><%= "yo, #{@user.name}" %></h1>
        <% else %>
            <h1 class="fw-bold"><%= t('.greet', user: @user.name.split(' ')[1]) %></h1>
        <% end %>

        <% unless @user.customer? %>
            <h4><%= t(".roles.#{@user.role}") %></h4>
        <% end %>
    </div>

    <% if @user.customer? && !@user.children.nil? %>
        <div class="card">
            <%= turbo_frame_tag "user#{@user.id}" do %>
                <div class="mb-3">
                    <ul>
                        <% schools.each do |school| %>
                            <li><%= t('.school_name', school: school) %></li>
                        <% end %>
                    </ul>
                </div>

                <div>
                    <h4 class="fw-bold"><%= t(".children") %></h4>

                    <ul>
                        <%= turbo_frame_tag "user#{@user.id}_children" do %>
                            <% @user.children.each do |child| %>
                                <li id="<%= "user#{@user.id}_child#{child.id}" %>">
                                    <%= link_to child.name, child_path(child), data: { turbo_frame: '_top' } %>
                                </li>
                            <% end %>             
                        <% end %>
                    </ul>

                </div>
            <% end %>
        </div>
    <% end %>

    <% if current_user.admin? && current_user.id != @user.id %>
        <div class="card">
            <%= link_to t(".edit"), edit_user_path(@user), class: 'btn btn-primary' %>
            <%= link_to t('.delete'), user_path(@user), data: { turbo_method: :delete, turbo_confirm: t('.delete_confirm'), turbo_frame: '_top' }, class: 'btn btn-primary' %>
        </div>
    <% end %>

    <% if @user.children? %>
        <% unless next_event.nil? %>
            <%= render next_event, child: @user.children.first %>
        <% end %>

        <div class="card">
            <%= link_to t('.user_bookings', user: @user.name), invoices_path(user: @user.id), class: 'btn btn-primary' %>
            <%= link_to t('.email_prefs'), mailer_subscriptions_path, class: 'btn btn-primary' %>
        </div>
    <% end %>

    <% if @user.admin? && current_user.admin? %>
        <h1><%= t('.admin_options') %></h1>

        <div class="card gap-3 padding-3">
            <%= link_to 'Import/Export Data', csvs_path, class: 'btn btn-primary' %>
            <%= link_to 'Manage Price Lists', price_lists_path, class: 'btn btn-primary' %>
            <%= link_to 'Create New Event', new_event_path, class: 'btn btn-primary' %>
        </div>
    <% end %>

    <% if @user.area_manager? %>
        <div class="card">
            <% @user.managed_areas.each do |area| %>
                <% area.schools.each do |school| %>
                    <h3><%= school.name %></h3>
                    <%= render partial: 'events/event_stats', collection: school.events %>
                <% end %>
            <% end %>
        </div>
    <% end %>

    <% if @user.school_manager? %>
        <div class="card">
            <% @user.managed_schools.each do |school| %>
                <h3><%= school.name %></h3>
                <%= render partial: 'events/event_stats', collection: school.events %>
            <% end %>
        </div>
    <% end %>

    <% unless @user.staff? %>
        <div id="add_child_container" class="card">
            <%= render 'users/add_child', parent: @user %>
        </div>
    <% end %>

    <% if @user.customer? && current_user.staff? && @user.children.any? { |c| c.ssid.nil? } %>
        <h2><%= t('.merge_children') %></h2>
        <div class="card" id="merge_children">
            <%= render 'users/merge_children', parent: @user %>
        </div>
    <% end %>
</main>