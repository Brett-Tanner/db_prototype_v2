<% next_event = @user.children.first.school.next_event if @user.customer? && @user.children.size.positive? %>
<% upcoming_events = School.real.map(&:next_event).compact if @user.admin? || @user.area_manager? %>
<% schools = @user.children.reject{ |c| c.school_id.nil? }.map(&:school).map(&:name).uniq if @user.customer? %>

<main id="user_show" class="gap-3">
    <div class="card text-center">
        <% if @user.admin? %>
          <h1 class="fw-bold"><%= "yo #{@user.name.split[0]}" %></h1>
        <% end %>
    </div>

    <% if @user.admin? && current_user.admin? %>
        <% unless upcoming_events.empty? %>
            <div class="card">
                <h2>All Schools</h2>
                <%= render partial: 'events/stats_summary', locals: { events: upcoming_events } %>
            </div>
        <% end %>

        <div class="card">
            <h3>Recent Bookings</h3>
            <%= render partial: 'invoices/recent_invoices', locals: { recent_invoices: Invoice.all.real.order(created_at: :desc).limit(5).includes(:child, :time_slots) } %>
        </div>

        <div class="card">
            <div class="table-responsive-lg">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr class="table-primary">
                            <th scope="col" 
                                data-controller="sort"
                                data-sort-col-value=".school">
                                School
                                <button
                                    class="btn-sort ascending"
                                    data-sort-target="toggle"
                                    data-action="click->sort#sort">
                                    &#9650;
                                </button>
                            </th>
                            <th scope="col" 
                                data-controller="sort"
                                data-sort-col-value=".int_kids"
                                >
                                <%= t('.int_kids') %>
                                <button
                                    class="btn-sort ascending"
                                    data-sort-target="toggle"
                                    data-action="click->sort#sort">
                                    &#9650;
                                </button>
                            </th>
                            <th scope="col" 
                                data-controller="sort"
                                data-sort-col-value=".res_kids">
                                <%= t('.res_kids') %>
                                <button
                                    class="btn-sort ascending"
                                    data-sort-target="toggle"
                                    data-action="click->sort#sort">
                                    &#9650;
                                </button>
                            </th>
                            <th scope="col" 
                                data-controller="sort"
                                data-sort-col-value=".ext_kids">
                                <%= t('.ext_kids') %>
                                <button
                                    class="btn-sort ascending"
                                    data-sort-target="toggle"
                                    data-action="click->sort#sort">
                                    &#9650;
                                </button>
                            </th>
                            <th scope="col" 
                                data-controller="sort"
                                data-sort-col-value=".total_kids">
                                <%= t('.total_kids') %>
                                <button
                                    class="btn-sort ascending"
                                    data-sort-target="toggle"
                                    data-action="click->sort#sort">
                                    &#9650;
                                </button>
                            </th>
                            <th scope="col" 
                                data-controller="sort"
                                data-sort-col-value=".photo_sales">
                                <%= t('.photo_sales') %>
                                <button
                                    class="btn-sort ascending"
                                    data-sort-target="toggle"
                                    data-action="click->sort#sort">
                                    &#9650;
                                </button>
                            </th>
                            <th scope="col" 
                                data-controller="sort"
                                data-sort-col-value=".total_revenue">
                                <%= t('.total_revenue') %>
                                <button
                                    class="btn-sort ascending"
                                    data-sort-target="toggle"
                                    data-action="click->sort#sort">
                                    &#9650;
                                </button>
                            </th>
                            <th scope="col" 
                                data-controller="sort"
                                data-sort-col-value=".goal_revenue">
                                <%= t('.goal_revenue') %>
                                <button
                                    class="btn-sort ascending"
                                    data-sort-target="toggle"
                                    data-action="click->sort#sort">
                                    &#9650;
                                </button>
                            </th>
                            <th scope="col" 
                                data-controller="sort"
                                data-sort-col-value=".goal_percent">
                                <%= t('.goal_percent') %>
                                <button
                                    class="btn-sort ascending"
                                    data-sort-target="toggle"
                                    data-action="click->sort#sort">
                                    &#9650;
                                </button>
                            </th>
                        </tr>
                    </thead>

                    <tbody id="condensed_stats">
                        <% School.real.each do |school| %>
                            <% next if school.next_event.nil? %>

                            <%= render partial: 'events/condensed_stats', locals: { event: school.next_event } %>
                        <% end %>
                    </tbody>
                </table>
            </div>
        </div>

        <h1>Admin Options</h1>
        <div class="card flex-row flex-wrap justify-content-evenly gap-3 padding-3">
            <%= link_to 'Import/Export Files', csvs_path, class: 'btn btn-primary' %>
            <%= link_to 'View Stats', charts_path, class: 'btn btn-primary' %>
            <%= link_to 'Manage Price Lists', price_lists_path, class: 'btn btn-primary' %>
            <%= link_to 'Create New Event', new_event_path, class: 'btn btn-primary' %>
        </div>
    <% end %>
</main>